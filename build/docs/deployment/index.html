<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Deploying the application on a server</title>
<!-- 2017-07-26 Wed 17:11 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="VLEAD" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../style/css/worg-style.css" />
<link rel="stylesheet" type="text/css" href="../style/css/override.css" />
<link rel="icon" type="image/png" href="../style/img/favicon/popl.png" />
<script type="text/javascript" src="../style/js/org-info.js">
/**
 *
 * @source: ../style/js/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in ../style/js/org-info.js.
 *
 * Copyright (C) 2012-2013 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in ../style/js/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "1");
org_html_manager.set("LINK_HOME", "../index.html");
org_html_manager.set("LINK_UP", "../index.html");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../index.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Deploying the application on a server</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a></li>
<li><a href="#sec-2">2. Install dependendent python packages</a></li>
<li><a href="#sec-3">3. Program to set up the database</a></li>
<li><a href="#sec-4">4. Program to populate lab and experiment data from lab spects</a></li>
<li><a href="#sec-5">5. Install all dependencies and setup the software</a></li>
<li><a href="#sec-6">6. Configuring the application and its deployment</a></li>
<li><a href="#sec-7">7. Deploying the application</a></li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This document will illustrate installation of all the dependencies required
for setting up the application.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Install dependendent python packages</h2>
<div class="outline-text-2" id="text-2">
<p>
Here we use the <code>setuptools</code> module from the standard lib, to make a
<code>setup.py</code> file, which will install all the python library dependencies.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="font-weight: bold;">from</span> setuptools <span style="font-weight: bold;">import</span> setup

<span style="font-weight: bold; font-style: italic;">requires</span> = [
    <span style="font-style: italic;">'Flask'</span>,
    <span style="font-style: italic;">'Flask-SQLAlchemy'</span>,
    <span style="font-style: italic;">'oursql'</span>,
    <span style="font-style: italic;">'flask-cors'</span>,
    <span style="font-style: italic;">'flask-testing'</span>,
    <span style="font-style: italic;">'requests'</span>,
    <span style="font-style: italic;">'pyyaml'</span>
]

setup(
    name=<span style="font-style: italic;">'lds'</span>,
    version=<span style="font-style: italic;">'2.0'</span>,
    install_requires=requires
)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Program to set up the database</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-python"><span style="font-weight: bold;">from</span> runtime.rest.app <span style="font-weight: bold;">import</span> create_app
<span style="font-weight: bold;">from</span> runtime.config <span style="font-weight: bold;">import</span> flask_app_config <span style="font-weight: bold;">as</span> config
<span style="font-weight: bold;">from</span> runtime.utils.class_persistence_template <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> runtime.system.system <span style="font-weight: bold;">import</span> System
<span style="font-weight: bold;">from</span> runtime.config.system_config <span style="font-weight: bold;">import</span> KEY

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">populate</span>():
    <span style="font-weight: bold; font-style: italic;">session_cls</span> = System.delegate.entities[<span style="font-style: italic;">'session'</span>]
    <span style="font-weight: bold; font-style: italic;">institute_cls</span> = System.delegate.entities[<span style="font-style: italic;">'institute'</span>]
    <span style="font-weight: bold; font-style: italic;">discipline_cls</span> = System.delegate.entities[<span style="font-style: italic;">'discipline'</span>]
    <span style="font-weight: bold; font-style: italic;">integration_status_cls</span> = System.delegate.entities[<span style="font-style: italic;">'integration_status'</span>]

    <span style="font-weight: bold; font-style: italic;">inst1</span> = institute_cls(institute_name=<span style="font-style: italic;">"Amrita University"</span>, institute_id=<span style="font-style: italic;">"amrita"</span>,
                              assets=[])
    inst1.save()
    <span style="font-weight: bold; font-style: italic;">inst2</span> = institute_cls(institute_name=<span style="font-style: italic;">"College of Engineering, Pune"</span>,
                              institute_id=<span style="font-style: italic;">"coep"</span>, assets=[])
    inst2.save()
    <span style="font-weight: bold; font-style: italic;">inst3</span> = institute_cls(institute_name=<span style="font-style: italic;">"Dayalbagh Educational institute_cls"</span>,
                          institute_id=<span style="font-style: italic;">"dei"</span>, assets=[])
    inst3.save()
    <span style="font-weight: bold; font-style: italic;">inst4</span> = institute_cls(institute_name=<span style="font-style: italic;">"IIT Bombay"</span>, institute_id=<span style="font-style: italic;">"iitb"</span>, assets=[])
    inst4.save()
    <span style="font-weight: bold; font-style: italic;">inst5</span> = institute_cls(institute_name=<span style="font-style: italic;">"IIT Delhi"</span>, institute_id=<span style="font-style: italic;">"iitd"</span>, assets=[])
    inst5.save()
    <span style="font-weight: bold; font-style: italic;">inst6</span> = institute_cls(institute_name=<span style="font-style: italic;">"IIT Guwahati"</span>, institute_id=<span style="font-style: italic;">"iitg"</span>, assets=[])
    inst6.save()
    <span style="font-weight: bold; font-style: italic;">inst7</span> = institute_cls(institute_name=<span style="font-style: italic;">"IIIT Hyderabad"</span>, institute_id=<span style="font-style: italic;">"iiith"</span>,
                              assets=[])
    inst7.save()
    <span style="font-weight: bold; font-style: italic;">inst8</span> = institute_cls(institute_name=<span style="font-style: italic;">"IIT Kanpur"</span>, institute_id=<span style="font-style: italic;">"iitk"</span>, assets=[])
    inst8.save()
    <span style="font-weight: bold; font-style: italic;">inst9</span> = institute_cls(institute_name=<span style="font-style: italic;">"IIT Kharagpur"</span>, institute_id=<span style="font-style: italic;">"iitkgp"</span>,
                              assets=[])
    inst9.save()
    <span style="font-weight: bold; font-style: italic;">inst10</span> = institute_cls(institute_name=<span style="font-style: italic;">"IIT Madras"</span>, institute_id=<span style="font-style: italic;">"iitm"</span>, assets=[])
    inst10.save()
    <span style="font-weight: bold; font-style: italic;">inst11</span> = institute_cls(institute_name=<span style="font-style: italic;">"IIT Roorkee"</span>, institute_id=<span style="font-style: italic;">"iitr"</span>, assets=[])
    inst11.save()
    <span style="font-weight: bold; font-style: italic;">inst12</span> = institute_cls(institute_name=<span style="font-style: italic;">"NIT Surathkal"</span>, institute_id=<span style="font-style: italic;">"nitk"</span>,
                               assets=[])
    inst12.save()

    <span style="font-weight: bold; font-style: italic;">dis1</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Aerospace Engineering"</span>, discipline_id=<span style="font-style: italic;">"aero"</span>,
                              assets=[])
    dis1.save()
    <span style="font-weight: bold; font-style: italic;">dis2</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Biotechnology and Biomedical Engineering"</span>,
                          discipline_id=<span style="font-style: italic;">"biotech"</span>, assets=[])
    dis2.save()
    <span style="font-weight: bold; font-style: italic;">dis3</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Chemical Engineering"</span>,
                              discipline_id=<span style="font-style: italic;">"chem-engg"</span>, assets=[])
    dis3.save()
    <span style="font-weight: bold; font-style: italic;">dis4</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Chemical Sciences"</span>,
                              discipline_id=<span style="font-style: italic;">"chem"</span>, assets=[])
    dis4.save()
    <span style="font-weight: bold; font-style: italic;">dis5</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Civil Engineering"</span>,
                              discipline_id=<span style="font-style: italic;">"civil"</span>, assets=[])
    dis5.save()
    <span style="font-weight: bold; font-style: italic;">dis6</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Computer Science and Engineering"</span>,
                          discipline_id=<span style="font-style: italic;">"cse"</span>, assets=[])
    dis6.save()
    <span style="font-weight: bold; font-style: italic;">dis7</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Electrical Engineering"</span>,
                              discipline_id=<span style="font-style: italic;">"ee"</span>, assets=[])
    dis7.save()
    <span style="font-weight: bold; font-style: italic;">dis8</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Electronics and Communication"</span>,
                              discipline_id=<span style="font-style: italic;">"ece"</span>, assets=[])
    dis8.save()
    <span style="font-weight: bold; font-style: italic;">dis9</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Humanities"</span>, discipline_id=<span style="font-style: italic;">"hmt"</span>, assets=[])
    dis9.save()
    <span style="font-weight: bold; font-style: italic;">dis10</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Mechanical Engineering"</span>,
                               discipline_id=<span style="font-style: italic;">"mech"</span>, assets=[])
    dis10.save()
    <span style="font-weight: bold; font-style: italic;">dis11</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Physical Sciences"</span>,
                               discipline_id=<span style="font-style: italic;">"phy-sc"</span>, assets=[])
    dis11.save()
    <span style="font-weight: bold; font-style: italic;">dis12</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Textile Engineering"</span>,
                               discipline_id=<span style="font-style: italic;">"tex-engg"</span>, assets=[])
    dis12.save()
    <span style="font-weight: bold; font-style: italic;">dis13</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Design Engineering"</span>,
                               discipline_id=<span style="font-style: italic;">"dsgn-engg"</span>, assets=[])
    dis13.save()
    <span style="font-weight: bold; font-style: italic;">dis14</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Material Sciences"</span>,
                               discipline_id=<span style="font-style: italic;">"mat-sc"</span>, assets=[])
    dis14.save()

    <span style="font-weight: bold; font-style: italic;">dis15</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Metallurgical and Materials Engineering"</span>,
                               discipline_id=<span style="font-style: italic;">"mm-engg"</span>, assets=[])
    dis15.save()

    <span style="font-weight: bold; font-style: italic;">dis16</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Mining Engineering"</span>,
                               discipline_id=<span style="font-style: italic;">"mine-engg"</span>, assets=[])
    dis16.save()

    <span style="font-weight: bold; font-style: italic;">dis17</span> = discipline_cls(discipline_name=<span style="font-style: italic;">"Industrial and Systems Engineering"</span>,
                               discipline_id=<span style="font-style: italic;">"is-engg"</span>, assets=[])
    dis17.save()

    <span style="font-weight: bold; font-style: italic;">integration_status0</span> = integration_status_cls(integration_level=0)
    integration_status0.save()

    <span style="font-weight: bold; font-style: italic;">integration_status1</span> = integration_status_cls(integration_level=1)
    integration_status1.save()

    <span style="font-weight: bold; font-style: italic;">integration_status2</span> = integration_status_cls(integration_level=2)
    integration_status2.save()

    <span style="font-weight: bold; font-style: italic;">integration_status3</span> = integration_status_cls(integration_level=3)
    integration_status3.save()

    <span style="font-weight: bold; font-style: italic;">integration_status4</span> = integration_status_cls(integration_level=4)
    integration_status4.save()

    <span style="font-weight: bold; font-style: italic;">integration_status5</span> = integration_status_cls(integration_level=5)
    integration_status5.save()

    <span style="font-weight: bold; font-style: italic;">integration_status6</span> = integration_status_cls(integration_level=6)
    integration_status6.save()

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    db.create_all(app=create_app(config))
    populate()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Program to populate lab and experiment data from lab spects</h2>
<div class="outline-text-2" id="text-4">
<div class="org-src-container">

<pre class="src src-python"><span style="font-weight: bold;">import</span> os
<span style="font-weight: bold;">import</span> os.path
<span style="font-weight: bold;">import</span> json
<span style="font-weight: bold;">import</span> requests
<span style="font-weight: bold;">import</span> glob

<span style="font-weight: bold; font-style: italic;">URL</span>= <span style="font-style: italic;">'http://localhost:5000'</span>
<span style="font-weight: bold; font-style: italic;">json_path_list</span> = []

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_lab_spec</span>(file_path):

    <span style="font-weight: bold;">with</span> <span style="font-weight: bold;">open</span>(file_path) <span style="font-weight: bold;">as</span> json_file:
        <span style="font-weight: bold;">print</span> file_path
        <span style="font-weight: bold; font-style: italic;">data</span> = json.load(json_file)
        <span style="font-weight: bold;">if</span> <span style="font-style: italic;">'lab'</span> <span style="font-weight: bold;">in</span> data.keys():
            <span style="font-weight: bold; font-style: italic;">end_point</span> = <span style="font-style: italic;">"/labs"</span>
        <span style="font-weight: bold;">if</span> <span style="font-style: italic;">'experiment'</span> <span style="font-weight: bold;">in</span> data.keys():
            <span style="font-weight: bold; font-style: italic;">end_point</span> = <span style="font-style: italic;">"/experiments"</span>

        <span style="font-weight: bold; font-style: italic;">data</span>[<span style="font-style: italic;">'key'</span>] = <span style="font-style: italic;">'defaultkey'</span>
        <span style="font-weight: bold; font-style: italic;">APP_URL</span> = URL + end_point
        <span style="font-weight: bold; font-style: italic;">headers</span> = {<span style="font-style: italic;">'Content-Type'</span>: <span style="font-style: italic;">'application/json'</span>}
        <span style="font-weight: bold;">try</span>:
            <span style="font-weight: bold; font-style: italic;">response</span> = requests.post(APP_URL, data = json.dumps(data),
                                     headers=headers)
            <span style="font-weight: bold;">if</span> response.status_code == 200:
                <span style="font-weight: bold;">print</span> <span style="font-style: italic;">"Added json data : "</span> + file_path
            <span style="font-weight: bold;">else</span>:
                <span style="font-weight: bold;">print</span> <span style="font-style: italic;">"Errore in adding json file "</span> + file_path + <span style="font-style: italic;">" due to "</span> + response.text
        <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
            <span style="font-weight: bold;">print</span> <span style="font-weight: bold;">str</span>(e)
<span style="font-weight: bold;">try</span>:
    exp_file_list = glob.glob(os.getcwd() + <span style="font-style: italic;">"/e9*.json"</span>)
    lab_file_list = glob.glob(os.getcwd() + <span style="font-style: italic;">"/[!e9]*.json"</span>)

    <span style="font-weight: bold;">for</span> filename <span style="font-weight: bold;">in</span> exp_file_list:
        json_path_list.append(filename)
<span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
    <span style="font-weight: bold;">print</span> <span style="font-weight: bold;">str</span>(e)

<span style="font-weight: bold;">for</span> file_path <span style="font-weight: bold;">in</span> json_path_list:
    post_lab_spec(file_path)
post_lab_spec(lab_file_list[0])
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Install all dependencies and setup the software</h2>
<div class="outline-text-2" id="text-5">
<p>
Install all dependencies, including the OS related packages, Python packages,
setup the database, configure the webserver, and finally deploy the
application.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/bin/</span><span style="font-weight: bold;">bash</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Shell script to install deb package dependencies as well as python package</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">dependencies for dataservice.</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">if any proxy server</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">PROXY=""</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file to store the generated password</span>
<span style="font-weight: bold; font-style: italic;">DB_PASS_FILE</span>=<span style="font-style: italic;">"db_pass.txt"</span>

<span style="font-weight: bold;">if</span> [[ <span style="font-weight: bold;">`id -u`</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"You have to execute this script as super user!"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Update the packages</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Updating package cache.."</span>
apt-get -y update
<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">?</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Updating package cache failed!"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Installing MySQL database.."</span>
<span style="font-weight: bold;">if</span> [ ! -f $<span style="font-weight: bold; font-style: italic;">DB_PASS_FILE</span> ]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">generate a random password for the database and store it in the $DB_PASS_FILE</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file</span>
<span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">DBPASS=$(</span><span style="font-weight: bold;">date</span><span style="font-weight: bold; font-style: italic;"> +%s | sha256sum | head -c 32)</span>
  <span style="font-weight: bold; font-style: italic;">DBPASS</span>=<span style="font-style: italic;">"root"</span>
  <span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">DBPASS</span> &gt; $<span style="font-weight: bold; font-style: italic;">DB_PASS_FILE</span>
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Install MySQL Server in a Non-Interactive mode.</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"mysql-server mysql-server/root_password password $DBPASS"</span> | sudo debconf-set-selections
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"mysql-server mysql-server/root_password_again password $DBPASS"</span> | sudo debconf-set-selections
apt-get install -y mysql-server
<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">?</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"FATAL: MySQL installation failed!"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Install pre-requsite dependencies: python-dev, mysqld-dev, setuptools,</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">apache, mod_wsgi etc.</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Installing pre-requisite dependencies.."</span>
apt-get install -y python-dev libmysqld-dev python-setuptools apache2 libapache2-mod-wsgi
<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">?</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"FATAL: Installing pre-requisite dependencies failed!"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Enabling the mod WSGI on apache"</span>
a2enmod wsgi
<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">?</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"FATAL: Unable to enable mod wsgi!"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Installing python dependencies</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Installing dependencies.."</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">export http_proxy=$PROXY</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">export https_proxy=$PROXY</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">python setup.py install</span>
mkdir -p build/oursql
<span style="font-weight: bold;">cd</span> build/oursql
wget https://pypi.python.org/packages/8c/88/9f53a314a2af6f56c0a1249c5673ee384b85dc791bac5c1228772ced3502/oursql-0.9.3.2.tar.gz#<span style="font-weight: bold; font-style: italic;">md5</span>=ade5959a6571b1626966d47f3ab2d315
tar xvf oursql-0.9.3.2.tar.gz
<span style="font-weight: bold;">cd</span> oursql-0.9.3.2
python setup.py install

pip install Flask Flask-SQLAlchemy oursql requests flask-cors flask-testing

<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">?</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"FATAL: Installation failed!"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold;">exit</span> 0
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Configuring the application and its deployment</h2>
<div class="outline-text-2" id="text-6">
<p>
The following program configures the application, configures the web server
to use WSGI and use the application scripts, and finally calls the database
setup scripts to actually setup the database with tables.
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/bin/</span><span style="font-weight: bold;">bash</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Configure the application in the deployment environment</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">1. Update the config.py file with appropriate values</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">2. Update the apache config to server via WSGI</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">3. Run the database setup scripts to setup the database</span>

<span style="font-weight: bold;">if</span> [[ <span style="font-weight: bold;">`id -u`</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"You have to execute this script as super user!"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>

<span style="font-weight: bold; font-style: italic;">ABS_PATH_DS</span>=$( <span style="font-weight: bold;">cd</span> <span style="font-style: italic;">"$( dirname "${BASH_SOURCE[0]}" )"</span> &amp;&amp; <span style="font-weight: bold;">pwd</span> )

<span style="font-weight: bold;">update_app_config</span> () {
  <span style="font-weight: bold; font-style: italic;">CONFIG_FILE</span>=<span style="font-style: italic;">"../runtime/config/flask_app_config.py"</span>
  <span style="font-weight: bold; font-style: italic;">DB_USER</span>=<span style="font-style: italic;">"root"</span>
  <span style="font-weight: bold; font-style: italic;">DB_PASS</span>=$(<span style="font-weight: bold;">cat</span> db_pass.txt)
  <span style="font-weight: bold; font-style: italic;">DB_NAME</span>=<span style="font-style: italic;">"lds"</span>
  <span style="font-weight: bold; font-style: italic;">DB_SERVER</span>=<span style="font-style: italic;">"localhost"</span>

  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">the list of white-listed IPs for POST/PUT requests to data service</span>
  <span style="font-weight: bold; font-style: italic;">WHITELIST_IPS</span>=<span style="font-style: italic;">"['127.0.0.1']"</span>

  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">the list of allowed domains for CORS</span>
  <span style="font-weight: bold; font-style: italic;">ALLOWED_ORIGINS</span>=<span style="font-style: italic;">"['*']"</span>

  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Updating config.py.."</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Update parts of the DB URI</span>
  sed -i <span style="font-style: italic;">"s/&lt;userid&gt;/$DB_USER/"</span> $<span style="font-weight: bold; font-style: italic;">ABS_PATH_DS</span>/$<span style="font-weight: bold; font-style: italic;">CONFIG_FILE</span>
  sed -i <span style="font-style: italic;">"s/&lt;password&gt;/$DB_PASS/"</span> $<span style="font-weight: bold; font-style: italic;">ABS_PATH_DS</span>/$<span style="font-weight: bold; font-style: italic;">CONFIG_FILE</span>
  sed -i <span style="font-style: italic;">"s/&lt;servername&gt;/$DB_SERVER/"</span> $<span style="font-weight: bold; font-style: italic;">ABS_PATH_DS</span>/$<span style="font-weight: bold; font-style: italic;">CONFIG_FILE</span>
  sed -i <span style="font-style: italic;">"s/&lt;db_name&gt;/$DB_NAME/"</span> $<span style="font-weight: bold; font-style: italic;">ABS_PATH_DS</span>/$<span style="font-weight: bold; font-style: italic;">CONFIG_FILE</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">update SQLALCHEMY_ECHO</span>
  sed -i <span style="font-style: italic;">"s/^SQLALCHEMY_ECHO.*$/SQLALCHEMY_ECHO = False/"</span> $<span style="font-weight: bold; font-style: italic;">ABS_PATH_DS</span>/$<span style="font-weight: bold; font-style: italic;">CONFIG_FILE</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">update WHITELIST_IPS</span>
  <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">sed -i "s/^WHITELIST_IPS.*$/WHITELIST_IPS = $WHITELIST_IPS/" $CONFIG_FILE</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">update ALLOWED_ORIGINS</span>
  <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">sed -i "s/^ALLOWED_ORIGINS.*$/ALLOWED_ORIGINS = $ALLOWED_ORIGINS/" $CONFIG_FILE</span>

  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">NOTE: this is hardcoded now..somehow the log file when dynamically created</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">is owned by root. then the app fails to run.. hence the following is</span>
  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">necessary</span>
}

<span style="font-weight: bold;">update_apache_config</span>() {
  <span style="font-weight: bold; font-style: italic;">PROC_NAME</span>=<span style="font-style: italic;">"lds"</span>
  <span style="font-weight: bold; font-style: italic;">WSGI_SCRIPT</span>=<span style="font-style: italic;">"lds.wsgi"</span>
  <span style="font-weight: bold; font-style: italic;">APACHE_VHOST_FILE</span>=<span style="font-style: italic;">"/etc/apache2/sites-available/default"</span>

  sed -i <span style="font-style: italic;">"/&lt;\/VirtualHost&gt;/i \</span>
<span style="font-style: italic;">    WSGIScriptAlias / $ABS_PATH_DS/$WSGI_SCRIPT</span>
<span style="font-style: italic;">  "</span> $<span style="font-weight: bold; font-style: italic;">APACHE_VHOST_FILE</span>

  <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">sed -i '/&lt;\/VirtualHost&gt;/i \</span>
  <span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">WSGIDaemonProcess $PROC_NAME user=www-data group=www-data threads=5</span>
  <span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">WSGIScriptAlias / $ABS_PATH_DS/$WSGI_SCRIPT</span>

  <span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">&lt;Directory $ABS_PATH_DS&gt;</span>
  <span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">WSGIProcessGroup $PROC_NAME</span>
  <span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">WSGIApplicationGroup %{GLOBAL}</span>
  <span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">Order deny,allow</span>
  <span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">Allow from all</span>
  <span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">&lt;/Directory&gt;</span>
  <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">' $APACHE_VHOST_FILE</span>

}

<span style="font-weight: bold;">setup_db</span>() {
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Creating database: $DB_NAME"</span>
  mysql -u $<span style="font-weight: bold; font-style: italic;">DB_USER</span> -p$<span style="font-weight: bold; font-style: italic;">DB_PASS</span> -Bse <span style="font-style: italic;">"create database $DB_NAME;"</span>
  <span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">?</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
    <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"Failed to create database $DB_NAME"</span>
    <span style="font-weight: bold;">exit</span> 1;
  <span style="font-weight: bold;">fi</span>

}

update_app_config
<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">?</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"FATAL: Failed to update application flask_app_config.py"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>
update_apache_config
<span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">?</span> -ne 0 ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"FATAL: Failed to update apache config"</span>
  <span style="font-weight: bold;">exit</span> 1;
<span style="font-weight: bold;">fi</span>

service apache2 restart
<span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">PYTHONPATH</span>=<span style="font-style: italic;">"/var/www"</span>
setup_db
<span style="font-weight: bold;">exit</span> 0;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Deploying the application</h2>
<div class="outline-text-2" id="text-7">
<div class="org-src-container">

<pre class="src src-python"><span style="font-weight: bold;">import</span> sys, os

<span style="font-weight: bold; font-style: italic;">BASE_DIR</span> = <span style="font-weight: bold; font-style: italic;">BASE_DIR</span> = os.path.join(os.path.dirname(os.path.abspath(__file__)))

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">sys.path.insert(0, BASE_DIR)</span>
sys.path.insert(0, <span style="font-style: italic;">"/var/www"</span>)

<span style="font-weight: bold;">from</span> runtime.rest.app <span style="font-weight: bold;">import</span> create_app
<span style="font-weight: bold;">from</span> runtime.config <span style="font-weight: bold;">import</span> flask_app_config <span style="font-weight: bold;">as</span> config

<span style="font-weight: bold; font-style: italic;">application</span> = create_app(config)
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: <span class="timestamp-wrapper"><span class="timestamp">[2016-06-07 Tue]</span></span></p>
<p class="author">Author: VLEAD</p>
<p class="date">Created: 2017-07-26 Wed 17:11</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
